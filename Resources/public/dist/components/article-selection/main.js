define(["underscore","config","text!./overlay.html","text!./contentItem.html","text!/admin/api/articles/fields"],function(a,b,c,d,e){"use strict";var f=JSON.parse(e),g=b.get("sulu_article"),h={options:{url:"/admin/api/articles",eventNamespace:"sulu.article-selection",resultKey:"articles",dataAttribute:"article-selection",dataDefault:[],hidePositionElement:!0,hideConfigButton:!0,navigateEvent:"sulu.router.navigate",translations:{noContentSelected:"sulu_article.selection.no-result"}},templates:{overlay:c,contentItem:d},translations:{title:"public.title",overlayTitle:"sulu_article.title"}},i=function(){this.sandbox.on("husky.overlay.article-selection."+this.options.instanceName+".add.initialized",j.bind(this)),this.sandbox.on("husky.overlay.article-selection."+this.options.instanceName+".add.opened",k.bind(this)),this.sandbox.on("husky.datagrid.article.view.rendered",function(){this.sandbox.emit("husky.overlay.article-selection."+this.options.instanceName+".add.set-position")}.bind(this)),this.sandbox.on("husky.tabs.overlayarticle-selection.articles.add.item.select",o.bind(this))},j=function(){this.sandbox.start([{name:"search@husky",options:{appearance:"white small",instanceName:this.options.instanceName+"-article-search",el:"#article-selection-"+this.options.instanceName+"-search"}},{name:"datagrid@husky",options:{el:"#article-selection-"+this.options.instanceName+"-list",instanceName:this.options.instanceName,url:this.url,preselected:this.getData()||[],resultKey:this.options.resultKey,sortable:!1,columnOptionsInstanceName:"",clickCallback:function(a){this.sandbox.emit("husky.datagrid."+this.options.instanceName+".toggle.item",a)}.bind(this),selectedCounter:!0,searchInstanceName:this.options.instanceName+"-article-search",searchFields:["id","title"],paginationOptions:{dropdown:{limit:20}},matchings:f}}])},k=function(){var a=this.getData()||[];this.sandbox.emit("husky.datagrid."+this.options.instanceName+".selected.update",a)},l=function(){this.sandbox.dom.on(this.$el,"click",function(){return!1}.bind(this),".search-icon"),this.sandbox.dom.on(this.$el,"keydown",function(a){if(13===event.keyCode)return a.preventDefault(),a.stopPropagation(),!1}.bind(this),".search-input")},m=function(){var b=this.sandbox.dom.createElement("<div/>"),c=$(this.templates.overlay({instanceName:this.options.instanceName})),d=g.types,e=g.typeNames,f=!1;if(this.sandbox.dom.append(this.$el,b),this.url=this.options.url,1!==e.length){if(f=[],g.displayTabAll===!0)f.push({name:"public.all",key:null});else{var h=this.options.url.indexOf("?")===-1?"?":"&";this.url=this.options.url+h+"type="+e[0]}a.each(e,function(a){f.push({title:d[a].title,data:c})}.bind(this)),c=null}this.sandbox.start([{name:"overlay@husky",options:{triggerEl:this.$addButton,cssClass:"article-content-overlay",el:b,removeOnClose:!1,container:this.$el,instanceName:"article-selection."+this.options.instanceName+".add",skin:"large",okCallback:n.bind(this),title:this.translations.overlayTitle,tabs:f,data:c}}])},n=function(){var a=[],b=this.getData();this.sandbox.emit("husky.datagrid."+this.options.instanceName+".items.get-selected",function(c){this.sandbox.util.foreach(c,function(c){var d=b.indexOf(c);d!==-1?a[d]=c:a.push(c)}.bind(this))}.bind(this));var c,d=Object.keys(a),e=[],f=d.length;for(c=0;c<f;c++)e.push(a[d[c]]);this.setData(e)},o=function(a){for(var b in g.types)if(g.types.hasOwnProperty(b)&&g.types[b].title===a.name)return this.type=b,this.sandbox.emit("husky.datagrid."+this.options.instanceName+".url.update",{type:b});this.type=null,this.sandbox.emit("husky.datagrid."+this.options.instanceName+".url.update",{type:null})};return{defaults:h,type:"itembox",initialize:function(){i.call(this),this.render(),m.call(this),l.call(this)},getUrl:function(a){var b=this.options.url.indexOf("?")===-1?"?":"&";return[this.options.url,b,this.options.idsParameter,"=",(a||[]).join(",")].join("")},getItemContent:function(a){return this.templates.contentItem({item:a,locale:this.options.locale})},sortHandler:function(a){this.setData(a,!1)},removeHandler:function(a){for(var b=this.getData(),c=-1,d=b.length;++c<d;)if(a===b[c]){b.splice(c,1);break}this.setData(b,!1)}}});