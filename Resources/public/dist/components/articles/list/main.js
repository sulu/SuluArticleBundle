define(["underscore","services/husky/storage","sulucontent/components/copy-locale-overlay/main","sulucontent/components/open-ghost-overlay/main","services/suluarticle/article-manager"],function(a,b,c,d,e){"use strict";var f={options:{config:{},storageName:"articles"},templates:{list:['<div class="list-toolbar-container"></div>','<div class="list-info"></div>','<div class="datagrid-container"></div>','<div class="dialog"></div>'].join(""),draftIcon:'<span class="draft-icon" title="<%= title %>"/>',publishedIcon:'<span class="published-icon" title="<%= title %>"/>',route:["articles","<% if (!!type) { %>:<%=type%><% } %>","/<%=locale%>"].join("")},translations:{headline:"sulu_article.list.title",unpublished:"public.unpublished",publishedWithDraft:"public.published-with-draft",filterMe:"sulu_article.list.filter.me",filterAll:"sulu_article.list.filter.all",filterBy:"sulu_article.list.filter.by",filterByCategory:"sulu_article.list.filter.by-category",openGhostOverlay:{info:"sulu_article.settings.open-ghost-overlay.info","new":"sulu_article.settings.open-ghost-overlay.new",copy:"sulu_article.settings.open-ghost-overlay.copy",ok:"sulu_article.settings.open-ghost-overlay.ok"}}};return{defaults:f,data:{contactId:null},header:function(){this.storage=b.get("sulu",this.options.storageName);var c,d=this.options.config.types,e=this.options.config.typeNames,f={icon:"plus-circle",title:"public.add-new"},g=!1,h=null,i=this.options.type||this.storage.getWithDefault("type",null);return 1===e.length?f.callback=function(){this.toAdd(e[0])}.bind(this):(f.dropdownItems=a.map(e,function(a){return{title:d[a].title,callback:function(){this.toAdd(a)}.bind(this)}}.bind(this)),c=[],this.options.config.displayTabAll===!0&&c.push({name:"public.all",key:null}),a.each(e,function(a){c.push({id:a,name:d[a].title,key:a}),a===i&&(h=d[a].title)}.bind(this)),g={componentOptions:{callback:this.typeChange.bind(this),preselector:"name",preselect:h},data:c}),{noBack:!0,tabs:g,toolbar:{buttons:{addArticle:{options:f},deleteSelected:{}},languageChanger:{data:this.options.config.languageChanger,preSelected:this.options.locale}}}},layout:{content:{width:"max"}},initialize:function(){if(this.options.type)this.storage.set("type",this.options.type);else if(this.storage.has("type")){var a=this.templates.route({type:this.storage.get("type"),locale:this.options.locale});this.sandbox.emit("sulu.router.navigate",a,!1,!1),this.options.type=this.storage.get("type")}this.render(),this.bindCustomEvents()},render:function(){this.$el.html(this.templates.list());var a="/admin/api/articles?sortBy=authored&sortOrder=desc&locale="+this.options.locale+(this.options.type?"&type="+this.options.type:""),b=this.getFilterFromStorage(),f=this.getFilterTitle(b.filterKey,b.contact,b.category);b.contact&&(a+="&contactId="+b.contact.id),b.category&&(a+="&categoryId="+b.category.id),this.sandbox.sulu.initListToolbarAndList.call(this,"article","/admin/api/articles/fields",{el:this.$find(".list-toolbar-container"),instanceName:"articles",template:this.retrieveListToolbarTemplate(f)},{el:this.sandbox.dom.find(".datagrid-container"),url:a,storageName:this.options.storageName,searchInstanceName:"articles",searchFields:["title"],resultKey:"articles",instanceName:"articles",actionCallback:function(a,b){"ghost"===b.localizationState.state?e.load(a,this.options.locale).then(function(b){d.openGhost.call(this,b,this.translations.openGhostOverlay).then(function(b,d){b?c.copyLocale.call(this,a,d,[this.options.locale],function(){this.toEdit(a)}.bind(this)):this.toEdit(a)}.bind(this))}.bind(this)).fail(function(a){this.sandbox.emit("sulu.article.error",a.status,data)}.bind(this)):this.toEdit(a)}.bind(this),viewOptions:{table:{actionIconColumn:"title",badges:[{column:"title",callback:function(a,b){return!(!a.localizationState||"ghost"!==a.localizationState.state||a.localizationState.locale===this.options.locale)&&(b.title=a.localizationState.locale,b)}.bind(this)},{column:"title",callback:function(a,b){var c="",d=this.translations.unpublished;return a.published&&!a.publishedState&&(d=this.translations.publishedWithDraft,c+=this.templates.publishedIcon({title:d})),a.publishedState||(c+=this.templates.draftIcon({title:d})),b.title=c,b.cssClass="badge-none",b}.bind(this)}]}}})},toEdit:function(a,b){this.sandbox.emit("sulu.router.navigate","articles/"+(b||this.options.locale)+"/edit:"+a+"/details")},toAdd:function(a,b){this.sandbox.emit("sulu.router.navigate","articles/"+(b||this.options.locale)+"/add"+(this.options.config.typeNames.length>1?":"+a:""))},toList:function(a){1!==this.options.config.typeNames.length&&this.options.type?this.sandbox.emit("sulu.router.navigate","articles:"+this.options.type+"/"+(a||this.options.locale)):this.sandbox.emit("sulu.router.navigate","articles/"+(a||this.options.locale))},deleteItems:function(b){e.remove(b,this.options.locale).then(function(){a.each(b,function(a){this.sandbox.emit("husky.datagrid.articles.record.remove",a)}.bind(this))}.bind(this))},typeChange:function(a){var b=this.templates.route({type:a.key,locale:this.options.locale});this.options.type=a.key,this.sandbox.emit("husky.datagrid.articles.url.update",{page:1,type:a.key}),this.sandbox.emit("sulu.router.navigate",b,!1,!1),this.storage.set("type",a.key)},getCopyLocaleUrl:function(a,b,c){return e.getCopyLocaleUrl(a,b,c)},bindCustomEvents:function(){this.sandbox.on("husky.datagrid.articles.number.selections",function(a){var b=a>0?"enable":"disable";this.sandbox.emit("sulu.header.toolbar.item."+b,"deleteSelected",!1)}.bind(this)),this.sandbox.on("sulu.toolbar.delete",function(){this.sandbox.emit("husky.datagrid.articles.items.get-selected",this.deleteItems.bind(this))}.bind(this)),this.sandbox.on("sulu.header.language-changed",function(a){a.id!==this.options.locale&&(this.sandbox.sulu.saveUserSetting(this.options.config.settingsKey,a.id),this.toList(a.id))}.bind(this)),this.sandbox.on("husky.toolbar.articles.initialized",function(){this.sandbox.emit("husky.toolbar.articles.item.mark",this.getFilterFromStorage().filterKey)}.bind(this))},retrieveListToolbarTemplate:function(a){return this.sandbox.sulu.buttons.get({settings:{options:{dropdownItems:[{type:"columnOptions"}]}},filter:{options:{icon:"filter",group:2,title:a,showTitle:!0,dropdownOptions:{idAttribute:"id",markSelected:!0,changeButton:!1},dropdownItems:[{id:"all",title:this.translations.filterAll,callback:function(){this.applyFilterToList.call(this,"all",null)}.bind(this)},{id:"me",title:this.translations.filterMe,callback:function(){this.applyFilterToList.call(this,"me",this.sandbox.sulu.user.contact)}.bind(this)},{id:"filterBy",title:this.translations.filterBy+"...",callback:this.openContactSelectionOverlay.bind(this)},{divider:!0},{id:"filterByCategory",title:this.translations.filterByCategory,callback:this.openCategorySelectionOverlay.bind(this)}]}}})},openContactSelectionOverlay:function(){var a=$("<div/>");this.$el.append(a),this.sandbox.start([{name:"articles/list/contact-selection@suluarticle",options:{el:a,locale:this.options.locale,data:{contact:this.getFilterFromStorage().contact},selectCallback:function(a){this.applyFilterToList.call(this,"filterBy",a.contactItem)}.bind(this)}}])},openCategorySelectionOverlay:function(){var a=$("<div/>");this.$el.append(a),this.sandbox.start([{name:"articles/list/category-selection@suluarticle",options:{el:a,locale:this.options.locale,data:{category:this.getFilterFromStorage().category},selectCallback:function(a){this.applyFilterToList.call(this,"category",null,a.categoryItem)}.bind(this)}}])},applyFilterToList:function(a,b,c){this.storage.set("filter",{contact:b,category:c,filterKey:a});var d={contactId:b?b.id:null,categoryId:c?c.id:null};this.sandbox.emit("husky.datagrid.articles.url.update",d),this.sandbox.emit("husky.toolbar.articles.button.set","filter",{title:this.getFilterTitle(a,b,c)})},getFilterFromStorage:function(){return this.storage.getWithDefault("filter",{filterKey:"all",contact:null,category:null})},getFilterTitle:function(a,b,c){var d="";switch(a){case"all":d=this.translations.filterAll;break;case"filterBy":d=this.translations.filterBy+" "+b.firstName+" "+b.lastName;break;case"me":d=this.translations.filterMe;break;case"category":d=this.translations.filterByCategory+" "+c.name}return d}}});