define(["underscore","jquery","services/suluarticle/article-manager","services/suluarticle/article-router","services/suluarticle/property-configuration"],function(a,b,c,d,e){"use strict";return{layout:function(){return{extendExisting:!0,content:{width:this.options.preview?"fixed":"max",rightSpace:!1,leftSpace:!1}}},initialize:function(){this.saved=!0,this.render(),this.bindCustomEvents(),this.listenForChange()},bindCustomEvents:function(){this.sandbox.on("sulu.tab.template-change",function(a){this.checkRenderTemplate(a.template)},this),this.sandbox.on("sulu.content.contents.default-template",function(a){this.template=a,this.sandbox.emit("sulu.header.toolbar.item.change","template",a)}.bind(this)),this.sandbox.on("sulu.tab.save",this.save.bind(this))},listenForChange:function(){this.sandbox.dom.on(this.$el,"keyup",a.debounce(this.setDirty.bind(this),10),"input, textarea"),this.sandbox.dom.on(this.$el,"change",a.debounce(this.setDirty.bind(this),10),"input, textarea"),this.sandbox.dom.on(this.$el,"change",a.debounce(this.setDirty.bind(this),10),'input[type="checkbox"], select'),this.sandbox.on("sulu.content.changed",this.setDirty.bind(this))},setDirty:function(){this.saved=!1,this.sandbox.emit("sulu.tab.dirty")},save:function(a){if(!this.sandbox.form.validate(this.formId))return void this.sandbox.emit("sulu.tab.dirty",!0);var b=this.sandbox.form.getData(this.formId);this.options.adapter.save(this,b,a).done(function(a){return this.data=a,this.ghost&&!this.data.type?this.sandbox.emit("sulu.router.navigate",this.sandbox.mvc.history.fragment,!0,!0):void this.sandbox.emit("sulu.tab.saved",a.id,a)}.bind(this)).fail(function(a){this.sandbox.emit("sulu.article.error",a.status,a.responseJSON.code||0,b)}.bind(this))},render:function(){this.checkRenderTemplate(this.data.template||null)},checkRenderTemplate:function(a){return a&&this.template===a?this.sandbox.emit("sulu.header.toolbar.item.enable","template",!1):(this.sandbox.emit("sulu.header.toolbar.item.loading","template"),void(""===this.template||this.saved?this.loadFormTemplate(a):this.showRenderTemplateDialog(a)))},showRenderTemplateDialog:function(a){this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","content.template.dialog.content",function(){this.sandbox.emit("sulu.header.toolbar.item.enable","template",!1),this.template&&this.sandbox.emit("sulu.header.toolbar.item.change","template",this.template,!1)}.bind(this),function(){this.loadFormTemplate(a)}.bind(this))},loadFormTemplate:function(a){if(a||(a=this.options.config.types[this.options.type||this.data.articleType]["default"]),this.template=a,this.formId="#content-form-container",this.$container=this.sandbox.dom.createElement('<div id="content-form-container"/>'),this.html(this.$container),this.sandbox.form.getObject(this.formId)){var b=this.data;this.data=this.sandbox.form.getData(this.formId),b.id&&(this.data.id=b.id),this.data=this.sandbox.util.extend({},b,this.data)}this.sandbox.emit("sulu.article.update-page-switcher",a),require([this.getTemplateUrl(a)],this.renderFormTemplate.bind(this))},getTemplateUrl:function(a){var b="text!/admin/content/template/form";return b+=a?"/"+a+".html":".html",b+="?type=article&language="+this.options.locale,this.data.id&&(b+="&uuid="+this.data.id),b},renderFormTemplate:function(a){this.sandbox.dom.html(this.formId,this.sandbox.util.template(a,{translate:this.sandbox.translate,content:this.data,options:this.options,categoryLocale:this.options.locale,entityClass:"Sulu\\Bundle\\ArticleBundle\\Document\\ArticleDocument",entityId:this.options.id}));var b=this.options.adapter.prepareData(this.data,this);if(b.type&&"ghost"===b.type.name){var c=this.getTitleProperty(),d=this.getPageTitleProperty();this.ghost={locale:b.type.value,title:c?b[c.name]:"",pageTitle:d?b[d.name]:""},b={id:this.data.id,articleType:this.data.articleType}}this.options.adapter.beforeFormCreate(this),this.createForm(b).then(this.changeTemplateDropdownHandler.bind(this))},changeTemplateDropdownHandler:function(){this.template&&this.sandbox.emit("sulu.header.toolbar.item.change","template",this.template),this.sandbox.emit("sulu.header.toolbar.item.enable","template",!1)},createForm:function(a){var b=this.sandbox.form.create(this.formId),c=this.sandbox.data.deferred();return b.initialized.then(function(){this.sandbox.form.setData(this.formId,a).then(function(){if(this.ghost){var a=this.getTitleProperty(),b=this.getPageTitleProperty();a&&this.sandbox.dom.attr(a.$el,"placeholder",this.ghost.locale+": "+this.ghost.title),b&&this.sandbox.dom.attr(b.$el,"placeholder",this.ghost.locale+": "+this.ghost.pageTitle)}this.sandbox.start(this.$el,{reset:!0}).then(function(){if(this.initSortableBlock(),this.bindFormEvents(),c.resolve(),this.sandbox.emit("sulu.content.initialized"),this.options.preview){this.options.preview.bindDomEvents(this.$el);var a=this.options.adapter.prepareData(this.data,this);a.template=this.template,a.type&&"ghost"===a.type.name&&(a={id:a.id}),this.options.preview.updateContext({template:this.template},this.options.adapter.prepareData(a,this))}}.bind(this))}.bind(this))}.bind(this)),c.promise()},initSortableBlock:function(){var a,b=this.sandbox.dom.find(".sortable",this.$el);b&&b.length>0&&(this.sandbox.dom.sortable(b,"destroy"),a=this.sandbox.dom.sortable(b,{handle:".move",forcePlaceholderSize:!0}),this.sandbox.dom.unbind(a,"sortupdate"),a.bind("sortupdate",function(a){this.updatePreviewProperty(a.currentTarget,null),this.sandbox.emit("sulu.content.changed")}.bind(this)))},bindFormEvents:function(){this.sandbox.dom.on(this.formId,"form-remove",function(a,b){this.initSortableBlock(),this.setDirty(),this.updatePreviewProperty(a.currentTarget,b)}.bind(this)),this.sandbox.dom.on(this.formId,"form-add",function(a,b,c,d){var e=this.sandbox.dom.children(this.$find('[data-mapper-property="'+b+'"]')),f=void 0!==d&&e.length>d?e[d]:this.sandbox.dom.last(e);this.sandbox.start(f),this.setDirty(),this.initSortableBlock(),this.updatePreviewProperty(a.currentTarget,b)}.bind(this)),this.sandbox.dom.on(this.formId,"init-sortable",function(a){this.initSortableBlock()}.bind(this))},loadComponentData:function(){return this.options.data()},updatePreviewProperty:function(a,b){if(this.options.preview){var c=this.sandbox.form.getData(this.formId);!b&&a&&(b=this.sandbox.dom.data(a,"mapperProperty")),this.options.preview.updateProperty(b,c[b])}},getTitleProperty:function(){return this.propertyConfiguration||(this.propertyConfiguration=e.generate(this.$el)),this.propertyConfiguration.tags["sulu_article.article_title"]?this.propertyConfiguration.tags["sulu_article.article_title"].highestProperty:this.propertyConfiguration.title},getPageTitleProperty:function(){return this.propertyConfiguration||(this.propertyConfiguration=e.generate(this.$el)),this.propertyConfiguration.tags["sulu_article.page_title"]?this.propertyConfiguration.tags["sulu_article.page_title"].highestProperty:this.propertyConfiguration.pageTitle?this.propertyConfiguration.pageTitle:void 0},getRoutePathProperty:function(){return this.propertyConfiguration||(this.propertyConfiguration=e.generate(this.$el)),this.propertyConfiguration.tags["sulu_article.article_route"]?this.propertyConfiguration.tags["sulu_article.article_route"].highestProperty:this.propertyConfiguration.routePath?this.propertyConfiguration.routePath:void 0}}});