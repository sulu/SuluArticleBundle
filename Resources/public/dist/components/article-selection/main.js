define(["underscore","config","services/suluwebsite/reference-store","text!./overlay.html","text!./contentItem.html","text!/admin/api/articles/fields","services/suluarticle/list-helper","services/suluarticle/overlay-filter-helper"],function(a,b,c,d,e,f,g,h){"use strict";var i=(JSON.parse(f),b.get("sulu_article")),j={options:{url:"/admin/api/articles?fields=title",eventNamespace:"sulu.article-selection",resultKey:"articles",dataAttribute:"article-selection",dataDefault:[],hidePositionElement:!0,hideConfigButton:!0,navigateEvent:"sulu.router.navigate",translations:{noContentSelected:"sulu_article.selection.no-result"}},templates:{overlay:d,contentItem:e},translations:{title:"public.title",overlayTitle:"sulu_article.title",authoredTitle:"sulu_article.authored",contactTitle:"sulu_article.contact-selection-overlay.title",categoryTitle:"sulu_article.category-selection-overlay.title",tagTitle:"sulu_article.tag-selection-overlay.title",pageTitle:"public.choose",apply:"sulu-content.teaser.apply"}},k=function(){this.sandbox.on("husky.overlay."+this.options.instanceName+".initialized",l.bind(this)),this.sandbox.on("husky.overlay."+this.options.instanceName+".opened",m.bind(this)),this.sandbox.on("husky.datagrid."+this.options.instanceName+".view.rendered",function(){this.sandbox.emit("husky.overlay."+this.options.instanceName+".set-position")}.bind(this)),this.sandbox.on("husky.tabs.overlay"+this.options.instanceName+".item.select",q.bind(this))},l=function(){this.sandbox.sulu.initListToolbarAndList.call(this,"article","/admin/api/articles/fields",{el:"#article-selection-"+this.options.instanceName+"-search",instanceName:this.options.instanceName,template:this.filterHelper.createToolbarTemplate(this.sandbox)},{el:"#article-selection-"+this.options.instanceName+"-list",instanceName:this.options.instanceName,url:this.url,preselected:this.getData()||[],resultKey:this.options.resultKey,clickCallback:function(a){this.sandbox.emit("husky.datagrid."+this.options.instanceName+".toggle.item",a)}.bind(this),selectedCounter:!0,searchInstanceName:this.options.instanceName,searchFields:["title","route_path","changer_full_name","creator_full_name","author_full_name"],paginationOptions:{dropdown:{limit:20}},viewOptions:{table:{actionIconColumn:"title",badges:[{column:"title",callback:function(a,b){return g.generateLocalizationBadge(a,b,this.options.locale)}.bind(this)},{column:"title",callback:g.generateWorkflowBadge}]}}}),this.filterHelper.startFilterComponents(this.sandbox)},m=function(){var a=this.getData()||[];this.sandbox.emit("husky.datagrid."+this.options.instanceName+".selected.update",a)},n=function(){this.sandbox.dom.on(this.$el,"click",function(){return!1}.bind(this),".search-icon"),this.sandbox.dom.on(this.$el,"keydown",function(a){if(13===event.keyCode)return a.preventDefault(),a.stopPropagation(),!1}.bind(this),".search-input")},o=function(){var b=this.sandbox.dom.createElement("<div/>"),c=$(this.templates.overlay({instanceName:this.options.instanceName})),d=i.types,e=i.typeNames,f=!1;this.sandbox.dom.append(this.$el,b);var g=this.options.url.indexOf("?")===-1?"?":"&";this.url=this.options.url+g+"locale="+this.options.locale,1!==e.length&&(f=[],i.displayTabAll===!0?f.push({title:"public.all",key:null,data:c}):this.url=this.options.url+g+"locale="+this.options.locale+"&type="+e[0],a.each(e,function(a){f.push({title:d[a].title,data:c})}.bind(this)),c=null),this.sandbox.start([{name:"overlay@husky",options:{triggerEl:this.$addButton,cssClass:"article-content-overlay",el:b,removeOnClose:!1,container:this.$el,instanceName:this.options.instanceName,skin:"large",slides:[{title:this.translations.overlayTitle,okCallback:p.bind(this),tabs:f,data:c},{title:this.translations.authoredTitle,cssClass:"authored-slide",contentSpacing:!0,okDefaultText:this.translations.apply,okCallback:function(){return this.sandbox.emit("sulu_article.article-selection."+this.options.instanceName+".ok-button.clicked"),!1}.bind(this),cancelCallback:function(){return this.sandbox.emit("husky.overlay."+this.options.instanceName+".slide-to",0),!1}.bind(this)},{title:this.translations.contactTitle,cssClass:"contact-slide",contentSpacing:!0,okDefaultText:this.translations.apply,okCallback:function(){return this.sandbox.emit("sulu_article.article-selection."+this.options.instanceName+".ok-button.clicked"),!1}.bind(this),cancelCallback:function(){return this.sandbox.emit("husky.overlay."+this.options.instanceName+".slide-to",0),!1}.bind(this)},{title:this.translations.categoryTitle,cssClass:"category-slide",contentSpacing:!0,okDefaultText:this.translations.apply,okCallback:function(){return this.sandbox.emit("sulu_article.article-selection."+this.options.instanceName+".ok-button.clicked"),!1}.bind(this),cancelCallback:function(){return this.sandbox.emit("husky.overlay."+this.options.instanceName+".slide-to",0),!1}.bind(this)},{title:this.translations.tagTitle,cssClass:"tag-slide",contentSpacing:!0,okDefaultText:this.translations.apply,okCallback:function(){return this.sandbox.emit("sulu_article.article-selection."+this.options.instanceName+".ok-button.clicked"),!1}.bind(this),cancelCallback:function(){return this.sandbox.emit("husky.overlay."+this.options.instanceName+".slide-to",0),!1}.bind(this)},{title:this.translations.pageTitle,cssClass:"page-slide data-source-slide",contentSpacing:!0,okDefaultText:this.translations.apply,okCallback:function(){return this.sandbox.emit("sulu_article.article-selection."+this.options.instanceName+".ok-button.clicked"),!1}.bind(this),cancelCallback:function(){return this.sandbox.emit("husky.overlay."+this.options.instanceName+".slide-to",0),!1}.bind(this)}]}}])},p=function(){var a=[],b=this.getData();this.sandbox.emit("husky.datagrid."+this.options.instanceName+".items.get-selected",function(c){this.sandbox.util.foreach(c,function(c){var d=b.indexOf(c);d!==-1?a[d]=c:a.push(c)}.bind(this))}.bind(this));var c,d=Object.keys(a),e=[],f=d.length;for(c=0;c<f;c++)e.push(a[d[c]]);this.setData(e)},q=function(a){if(this.type=null,a.name)for(var b in i.types)if(i.types.hasOwnProperty(b)&&i.types[b].title===a.name){this.type=b;break}this.sandbox.emit("husky.datagrid."+this.options.instanceName+".url.update",{type:this.type})};return{defaults:j,type:"itembox",initialize:function(){k.call(this),this.filterHelper=h.create(this.$el,this.options.instanceName,this.options.locale,"sulu_article.article-selection"),this.prefillReferenceStore(),this.render(),o.call(this),n.call(this)},getUrl:function(a){var b=this.options.url.indexOf("?")===-1?"?":"&";return[this.options.url,b,"locale="+this.options.locale,"&",this.options.idsParameter,"=",(a||[]).join(",")].join("")},getItemContent:function(a){return this.templates.contentItem({item:a,locale:this.options.locale})},sortHandler:function(a){this.setData(a,!1)},removeHandler:function(a){for(var b=this.getData(),c=-1,d=b.length;++c<d;)if(a===b[c]){b.splice(c,1);break}this.setData(b,!1)},prefillReferenceStore:function(){var a=this.getData();for(var b in a)a.hasOwnProperty(b)&&c.add("article",a[b])}}});